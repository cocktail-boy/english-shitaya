<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Shitaya Voice Trainer — Minimal Mobile</title>
  <style>
    :root { --bg:#fafafa; --card:#fff; --text:#1f1f1f; --muted:#666; --accent:#111; --border:#e6e6e6; --hi:#fff8e1; --hi-b:#ffe08a; }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,"Hiragino Kaku Gothic ProN","Yu Gothic","Noto Sans JP",Arial,sans-serif;}
    .container{max-width:900px;margin:0 auto;padding:16px;}
    h1{font-size:22px;margin:0 0 4px}
    .sub{color:var(--muted);font-size:12px;margin-bottom:12px}

    /* Compact toolbar */
    .toolbar{position:sticky;top:0;z-index:10;background:var(--bg);padding:8px 0;border-bottom:1px solid var(--border);} 
    .bar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .btn{border-radius:10px;padding:8px 10px;border:1px solid var(--border);background:#f2f2f2;cursor:pointer;font-size:14px}
    .btn.primary{background:#111;color:#fff;border-color:#000}
    .select{border:1px solid var(--border);border-radius:10px;padding:6px 8px;font-size:14px;background:#fff}

    /* Current line card front and center */
    .current{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px;margin:12px 0}
    .titleRow{color:var(--muted);font-size:12px}
    .en{font-size:20px;margin-top:6px;line-height:1.35}
    .jp{font-size:16px;color:#444;margin-top:2px}
    .feedback{background:var(--hi);border:1px solid var(--hi-b);padding:8px 10px;border-radius:10px;margin-top:10px;font-size:14px}

    /* Section chips: horizontally scrollable for mobile */
    .chips{display:flex;gap:8px;overflow-x:auto;padding:6px 2px;margin:8px 0}
    .chip{flex:0 0 auto;padding:6px 10px;border-radius:999px;border:1px solid var(--border);background:#f2f2f2;font-size:13px}
    .chip.active{background:#111;color:#fff;border-color:#000}

    /* Line list */
    .list{display:grid;grid-template-columns:1fr;gap:10px}
    @media(min-width:760px){.list{grid-template-columns:1fr 1fr}}
    .lineBtn{text-align:left;padding:10px;border-radius:12px;border:1px solid var(--border);background:#fff}
    .lineBtn.active{border-color:#111;background:#fafafa}
    .muted{color:var(--muted);font-size:12px}
    .progress{color:var(--muted);font-size:12px;margin-top:8px}
  </style>
</head>
<body>
  <div class="container">
    <h1>Shitaya Voice Trainer</h1>
    <div class="sub">Minimal mobile UI — English playback only, slow=0.7, auto-advance on good pronunciation.</div>

    <!-- Compact toolbar -->
    <div class="toolbar">
      <div class="bar">
        <button class="btn primary" id="btn-listen">Listen</button>
        <button class="btn" id="btn-listen-slow">Slow</button>
        <button class="btn" id="btn-repeat">Repeat</button>
        <button class="btn" id="btn-prev">◀ Prev</button>
        <button class="btn" id="btn-next">Next ▶</button>
        <select id="en-voice" class="select"></select>
      </div>
    </div>

    <!-- Section chips -->
    <div id="section-chips" class="chips"></div>

    <!-- Current line -->
    <div class="current">
      <div class="titleRow" id="title-row"></div>
      <div class="en" id="line-en"></div>
      <div class="jp" id="line-jp"></div>
      <div class="feedback" id="feedback" style="display:none"></div>
      <div class="progress" id="progress"></div>
    </div>

    <!-- List -->
    <div class="list" id="line-list"></div>
    <div style="height:28px"></div>
  </div>

  <script>
    // ====== Data (American English) ======
    const sections = [
      { titleJP:"【ご来店】", titleEN:"Upon Arrival", lines:[
        { jp:"靴を脱いでスリッパに履き替えてください。", en:"Please take off your shoes and change into slippers." },
        { jp:"ソファへおかけください。", en:"Please have a seat on the couch." },
        { jp:"何か飲み物は飲みますか？", en:"Would you like something to drink?" },
        { jp:"・お水", en:"Water" },
        { jp:"・ルイボスティー（ホット or アイス）", en:"Rooibos tea (Hot or Iced)" },
        { jp:"・コーヒー（ホット or アイス）", en:"Coffee (Hot or Iced)" },
      ]},
      { titleJP:"【メニュー説明】", titleEN:"Menu Explanation", lines:[
        { jp:"マッサージは最短90分からです。", en:"Our massage sessions start from 90 minutes." },
        { jp:"料金はこちらです。", en:"Here’s our price list." },
        { jp:"マッサージの時間に、支度（シャワー・お風呂・お着替え）として30分が追加されています。", en:"The total time includes an extra 30 minutes for prep time (shower, bath, or changing)." },
        { jp:"マッサージをせずお部屋利用のみの料金はこちらです。", en:"If you’d like to use the room without a massage, here’s the room rental fee." },
        { jp:"マッサージの種類：ドライ（指圧）、クリーム（オイルのような施術）、ストレッチ。", en:"Massage types: Dry (Shiatsu-style), Cream (similar to oil massage), and Stretching." },
        { jp:"オプション：リフレクソロジー、ドライヘッドスパ、クリームヘッドスパ（施術後に髪を洗います）。", en:"Optional add-ons: Reflexology, Dry head spa, and Cream head spa (requires washing your hair afterward)." },
        { jp:"今日はどの種類のマッサージにしますか？", en:"Which type of massage would you like today?" },
        { jp:"※組み合わせることもできます。", en:"You can also combine different styles if you like." },
        { jp:"今日はどこが疲れていますか？", en:"Where do you feel most tired or tense today?" },
      ]},
      { titleJP:"【お部屋の案内】", titleEN:"Room Guidance", lines:[
        { jp:"サウナルームをご案内します。", en:"Let me show you the sauna room." },
        { jp:"これがサウナです。", en:"This is the sauna." },
        { jp:"右側に温かいお風呂、左側に水風呂があります。", en:"There’s a warm bath area on the right and a cold bath on the left." },
        { jp:"トイレはこちらです。", en:"The restroom is right here." },
      ]},
      { titleJP:"【着替え】", titleEN:"Changing", lines:[
        { jp:"これに着替えてください。", en:"Please change into these clothes." },
        { jp:"着替えが終わったらiPadからメッセージを送ってください。", en:"When you’re ready, please send me a message from the iPad." },
        { jp:"今の時間（〇〇:〇〇）から支度の時間をスタートします。", en:"We’ll start your prep time from (XX:XX)." },
        { jp:"説明は以上ですが、何か質問はありますか？", en:"That’s all for the explanation — do you have any questions?" },
      ]},
      { titleJP:"【施術中】", titleEN:"During Treatment", lines:[
        { jp:"フットバスをするのでソファにおかけください。", en:"We’ll start with a foot bath. Please have a seat on the couch." },
        { jp:"施術用にベッドを作るので少しお待ちください。", en:"I’ll prepare the bed for your massage — please wait just a moment." },
        { jp:"うつ伏せに寝てください。", en:"Please lie face down." },
        { jp:"枕は寝心地どうですか？", en:"Is the pillow comfortable?" },
        { jp:"顔を埋める枕もありますが変えますか？", en:"We also have a face cradle — would you like to switch?" },
        { jp:"強さはいかがですか？", en:"How’s the pressure?" },
        { jp:"強くする／弱くする", en:"A little stronger / A little lighter" },
        { jp:"加減したい時は言ってください。", en:"Please let me know anytime if you’d like me to adjust the pressure." },
        { jp:"仰向けになります。", en:"Please turn over onto your back." },
        { jp:"お腹の下のクッションを抜きますね。", en:"I’ll remove the cushion under your stomach." },
        { jp:"トイレは行きますか？", en:"Would you like to use the restroom?" },
        { jp:"お水は飲みますか？", en:"Would you like some water?" },
      ]},
      { titleJP:"【施術後】", titleEN:"After Treatment", lines:[
        { jp:"以上で施術は終わりです。ありがとうございました。", en:"That’s the end of your session. Thank you very much." },
        { jp:"お部屋利用の時間は残り〇分です。", en:"You have about XX minutes left for room use." },
        { jp:"〇分後にお会計を持ってきます。", en:"I’ll bring the check in XX minutes." },
        { jp:"（30分以上ゆっくりする場合は、着替え終わったらまたメッセージを送ってください。）", en:"If you’d like to relax for more than 30 minutes, please send me a message once you’ve finished changing." },
      ]},
    ];

    // ====== State ======
    let sectionIdx = 0, lineIdx = 0;
    const rate = 1.0, slowRate = 0.7; // fixed
    const autoAdvance = true; // always on

    // ====== Elements ======
    const btnListen = document.getElementById('btn-listen');
    const btnListenSlow = document.getElementById('btn-listen-slow');
    const btnRepeat = document.getElementById('btn-repeat');
    const enVoiceSel = document.getElementById('en-voice');
    const btnPrev = document.getElementById('btn-prev');
    const btnNext = document.getElementById('btn-next');
    const progressEl = document.getElementById('progress');
    const titleRow = document.getElementById('title-row');
    const lineEN = document.getElementById('line-en');
    const lineJP = document.getElementById('line-jp');
    const feedback = document.getElementById('feedback');
    const list = document.getElementById('line-list');
    const chips = document.getElementById('section-chips');

    // ====== Voices (EN only) ======
    let voices = [], enVoices = [], enVoice = null;
    function loadVoices(){
      voices = window.speechSynthesis.getVoices();
      enVoices = voices.filter(v => v.lang && v.lang.toLowerCase().startsWith('en'));
      enVoiceSel.innerHTML = enVoices.map(v=>`<option>${v.name}</option>`).join('');
      if (!enVoice && enVoices[0]) enVoice = enVoices[0];
    }
    loadVoices();
    window.speechSynthesis.onvoiceschanged = loadVoices;
    enVoiceSel.addEventListener('change', e=>{ const name=e.target.value; enVoice = enVoices.find(v=>v.name===name)||null; });

    // ====== UI ======
    function buildChips(){
      chips.innerHTML = '';
      sections.forEach((s,i)=>{
        const b = document.createElement('button');
        b.className = 'chip' + (i===sectionIdx? ' active':'');
        b.textContent = s.titleEN;
        b.onclick = ()=>{ sectionIdx=i; lineIdx=0; hideFeedback(); render(); buildList(); buildChips(); };
        chips.appendChild(b);
      });
    }

    function buildList(){
      list.innerHTML = '';
      const curSec = sections[sectionIdx];
      curSec.lines.forEach((l, idx)=>{
        const b = document.createElement('button');
        b.className = 'lineBtn' + (idx===lineIdx? ' active':'');
        b.innerHTML = `<div class="muted">Line ${idx+1}</div><div class="en">${l.en}</div><div class="jp">${l.jp}</div>`;
        b.onclick = ()=>{ lineIdx=idx; hideFeedback(); render(); buildList(); };
        list.appendChild(b);
      });
    }

    function render(){
      const sec = sections[sectionIdx];
      const line = sec.lines[lineIdx];
      titleRow.textContent = `${sec.titleJP} / ${sec.titleEN}`;
      lineEN.textContent = line.en;
      lineJP.textContent = line.jp;
      progressEl.textContent = `Progress: Section ${sectionIdx+1}/${sections.length} • Line ${lineIdx+1}/${sec.lines.length}`;
    }

    // ====== Helpers ======
    function normalize(s){ return (s||'').toLowerCase().replace(/[^a-z'\s]/g,'').replace(/\s+/g,' ').trim(); }
    function similarity(a,b){
      const A = new Set(normalize(a).split(' '));
      const B = new Set(normalize(b).split(' '));
      if (!A.size && !B.size) return 1;
      let inter=0; A.forEach(w=>{ if(B.has(w)) inter++; });
      return inter / new Set([...A, ...B]).size;
    }

    function say(text, voice, r){
      return new Promise(resolve=>{
        const u = new SpeechSynthesisUtterance(text);
        if (voice) u.voice = voice;
        u.rate = r;
        u.onend = ()=>resolve();
        window.speechSynthesis.cancel();
        window.speechSynthesis.speak(u);
      });
    }

    function getRecognition(){
      const SR = window.webkitSpeechRecognition || window.SpeechRecognition;
      if (!SR) return null;
      const rec = new SR();
      rec.lang = 'en-US';
      rec.interimResults = false;
      rec.maxAlternatives = 1;
      return rec;
    }

    function hideFeedback(){ feedback.style.display='none'; feedback.textContent=''; }

    async function speakCurrent(slow){
      hideFeedback();
      const r = slow ? slowRate : rate;
      const line = sections[sectionIdx].lines[lineIdx];
      await say(line.en, enVoice, r);
    }

    function next(){
      const sec = sections[sectionIdx];
      if (lineIdx + 1 < sec.lines.length) lineIdx++;
      else if (sectionIdx + 1 < sections.length){ sectionIdx++; lineIdx=0; }
      hideFeedback();
      render(); buildList(); buildChips();
    }

    function prev(){
      if (lineIdx>0) lineIdx--; else if (sectionIdx>0){ sectionIdx--; lineIdx = sections[sectionIdx].lines.length-1; }
      hideFeedback();
      render(); buildList(); buildChips();
    }

    async function repeatMode(){
      const rec = getRecognition();
      await speakCurrent(false);
      if (!rec){
        feedback.style.display='block';
        feedback.textContent = 'Speech recognition not supported in this browser. Try Chrome.';
        return;
      }
      feedback.style.display='block';
      feedback.textContent = 'Listening...';
      rec.onresult = (ev)=>{
        const said = (ev.results[0] && ev.results[0][0] && ev.results[0][0].transcript) || '';
        const target = sections[sectionIdx].lines[lineIdx].en;
        const score = Math.round(similarity(target, said) * 100);
        feedback.textContent = `You said: "${said}" — Similarity: ${score}%`;
        if (autoAdvance && score >= 60) next();
      };
      rec.onerror = (e)=>{ feedback.textContent = `Recognition error: ${e.error||'unknown'}`; };
      rec.onend = ()=>{};
      try { rec.start(); } catch(err) {}
    }

    // Bindings
    document.getElementById('btn-listen').onclick = ()=>speakCurrent(false);
    document.getElementById('btn-listen-slow').onclick = ()=>speakCurrent(true);
    document.getElementById('btn-repeat').onclick = ()=>repeatMode();
    document.getElementById('btn-prev').onclick = prev;
    document.getElementById('btn-next').onclick = next;

    // Initial
    buildChips();
    buildList();
    render();
  </script>
</body>
</html>
